# System Architecture - Complete Approval Mechanism

## ğŸ—ï¸ High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT LAYER                                 â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Approval         â”‚              â”‚ Dynamic          â”‚            â”‚
â”‚  â”‚ Dashboard        â”‚              â”‚ Approval Form    â”‚            â”‚
â”‚  â”‚                  â”‚              â”‚                  â”‚            â”‚
â”‚  â”‚ - Pending queue  â”‚              â”‚ - 8 field types  â”‚            â”‚
â”‚  â”‚ - Completed list â”‚              â”‚ - Validation     â”‚            â”‚
â”‚  â”‚ - Progress view  â”‚              â”‚ - Approve/Reject â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                                  â”‚                      â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTP/REST API
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SERVER LAYER                                 â”‚
â”‚                           â”‚                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚           API Routes (/api/approvals)            â”‚               â”‚
â”‚  â”‚                                                   â”‚               â”‚
â”‚  â”‚  - POST /workflows           (create)            â”‚               â”‚
â”‚  â”‚  - GET  /workflows/:id       (retrieve)          â”‚               â”‚
â”‚  â”‚  - POST /workflows/:id/approve                   â”‚               â”‚
â”‚  â”‚  - POST /workflows/:id/reject                    â”‚               â”‚
â”‚  â”‚  - POST /workflows/:id/delegate                  â”‚               â”‚
â”‚  â”‚  - POST /workflows/:id/rollback                  â”‚               â”‚
â”‚  â”‚  - GET  /templates/:agentId                      â”‚               â”‚
â”‚  â”‚  - POST /templates                               â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                          â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚         Webhook Routes (/api/webhook)             â”‚              â”‚
â”‚  â”‚                                                    â”‚              â”‚
â”‚  â”‚  - POST /slack      (Slack approvals)             â”‚              â”‚
â”‚  â”‚  - POST /email      (Email approvals)             â”‚              â”‚
â”‚  â”‚  - POST /external   (External system approvals)   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚            Workflow Service                       â”‚              â”‚
â”‚  â”‚                                                    â”‚              â”‚
â”‚  â”‚  Business Logic:                                  â”‚              â”‚
â”‚  â”‚  - createWorkflow()                               â”‚              â”‚
â”‚  â”‚  - approveStep()                                  â”‚              â”‚
â”‚  â”‚  - rejectStep()                                   â”‚              â”‚
â”‚  â”‚  - delegateApproval()                             â”‚              â”‚
â”‚  â”‚  - rollbackWorkflow()                             â”‚              â”‚
â”‚  â”‚  - checkTimeouts()                                â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚              Agent Service                        â”‚              â”‚
â”‚  â”‚                                                    â”‚              â”‚
â”‚  â”‚  - Detects escalation                             â”‚              â”‚
â”‚  â”‚  - Creates workflow automatically                 â”‚              â”‚
â”‚  â”‚  - Uses templates                                 â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚           Event Emitter (workflowEvents)          â”‚              â”‚
â”‚  â”‚                                                    â”‚              â”‚
â”‚  â”‚  Events:                                          â”‚              â”‚
â”‚  â”‚  - workflow:created                               â”‚              â”‚
â”‚  â”‚  - workflow:step_advanced                         â”‚              â”‚
â”‚  â”‚  - workflow:approved                              â”‚              â”‚
â”‚  â”‚  - workflow:rejected                              â”‚              â”‚
â”‚  â”‚  - workflow:delegated                             â”‚              â”‚
â”‚  â”‚  - workflow:rolled_back                           â”‚              â”‚
â”‚  â”‚  - workflow:timeout                               â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                          â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      DATABASE LAYER                                  â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Workflows      â”‚  â”‚ Approval         â”‚  â”‚ Conversations    â”‚ â”‚
â”‚  â”‚   Collection     â”‚  â”‚ Templates        â”‚  â”‚ Collection       â”‚ â”‚
â”‚  â”‚                  â”‚  â”‚ Collection       â”‚  â”‚                  â”‚ â”‚
â”‚  â”‚ - workflowId     â”‚  â”‚ - templateId     â”‚  â”‚ - conversationId â”‚ â”‚
â”‚  â”‚ - status         â”‚  â”‚ - steps[]        â”‚  â”‚ - messages[]     â”‚ â”‚
â”‚  â”‚ - steps[]        â”‚  â”‚ - deadlines      â”‚  â”‚ - config         â”‚ â”‚
â”‚  â”‚ - stateHistory[] â”‚  â”‚ - permissions    â”‚  â”‚ - agentId        â”‚ â”‚
â”‚  â”‚ - deadline       â”‚  â”‚                  â”‚  â”‚                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                      â”‚
â”‚                        MongoDB Database                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Approval Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APPROVAL WORKFLOW LIFECYCLE                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ESCALATION TRIGGER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ User Message â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Agent Detectsâ”‚
   â”‚ Escalation   â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼

2. WORKFLOW CREATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WorkflowService.create()     â”‚
   â”‚                              â”‚
   â”‚ - Load template              â”‚
   â”‚ - Initialize steps           â”‚
   â”‚ - Set deadline               â”‚
   â”‚ - Create state snapshot      â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Status:      â”‚
   â”‚ PENDING      â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼

3. APPROVAL PROCESS (Multi-Step)
   
   Step 1: Manager Review
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Approver: manager@co.com    â”‚
   â”‚ Form Fields:                â”‚
   â”‚  - Budget approved? â˜‘       â”‚
   â”‚  - Comments: [text]         â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â”€â”€ APPROVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                      â”‚
          â”‚                      â–¼
          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚ Status:       â”‚
          â”‚              â”‚ IN_PROGRESS   â”‚
          â”‚              â”‚ currentStep++ â”‚
          â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚
          â”‚                      â–¼
          â”‚              Step 2: Director Review
          â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚ Approver: director@co.com   â”‚
          â”‚              â”‚ Form Fields:                â”‚
          â”‚              â”‚  - Priority: [select]       â”‚
          â”‚              â”‚  - Comments: [text]         â”‚
          â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚
          â”‚                     â”œâ”€â”€â”€ APPROVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚                      â”‚
          â”‚                     â”‚                      â–¼
          â”‚                     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚              â”‚ Status:       â”‚
          â”‚                     â”‚              â”‚ IN_PROGRESS   â”‚
          â”‚                     â”‚              â”‚ currentStep++ â”‚
          â”‚                     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                      â”‚
          â”‚                     â”‚                      â–¼
          â”‚                     â”‚              Step 3: CFO Approval
          â”‚                     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚              â”‚ Approver: cfo@co.com        â”‚
          â”‚                     â”‚              â”‚ Form Fields:                â”‚
          â”‚                     â”‚              â”‚  - Amount: [number]         â”‚
          â”‚                     â”‚              â”‚  - Final approval: â˜‘        â”‚
          â”‚                     â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â”‚                     â”‚                     â”œâ”€â”€â”€ APPROVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚                     â”‚                      â”‚
          â”‚                     â”‚                     â”‚                      â–¼
          â”‚                     â”‚                     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚                     â”‚              â”‚ Status:       â”‚
          â”‚                     â”‚                     â”‚              â”‚ APPROVED âœ…   â”‚
          â”‚                     â”‚                     â”‚              â”‚ Workflow Done â”‚
          â”‚                     â”‚                     â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚                     â”‚
          â”‚                     â”‚                     â””â”€â”€â”€ REJECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                     â”‚                                           â”‚
          â”‚                     â””â”€â”€â”€ REJECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
          â”‚                                           â”‚                     â”‚
          â””â”€â”€â”€ REJECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚                     â”‚
                                â”‚                     â”‚                     â”‚
                                â–¼                     â–¼                     â–¼
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ Status:       â”‚    â”‚ Status:       â”‚    â”‚ Status:       â”‚
                         â”‚ REJECTED âŒ   â”‚    â”‚ REJECTED âŒ   â”‚    â”‚ REJECTED âŒ   â”‚
                         â”‚ Workflow Done â”‚    â”‚ Workflow Done â”‚    â”‚ Workflow Done â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. SPECIAL ACTIONS

   DELEGATE:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Current: manager@co.com     â”‚
   â”‚ Delegate to: senior@co.com  â”‚
   â”‚ Reason: On vacation         â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Step status: DELEGATED      â”‚
   â”‚ New approver: senior@co.com â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   ROLLBACK:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Triggered by: admin@co.com  â”‚
   â”‚ Action: Rollback to prev    â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Restore from state snapshot â”‚
   â”‚ currentStep--               â”‚
   â”‚ Status reverted             â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   TIMEOUT:
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Deadline passed             â”‚
   â”‚ No approval received        â”‚
   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Status: TIMEOUT â°          â”‚
   â”‚ Workflow terminated         â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATA FLOW                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. USER INTERACTION
   User sends message
        â”‚
        â–¼
   Agent processes
        â”‚
        â–¼
   Escalation detected
        â”‚
        â–¼

2. WORKFLOW CREATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WorkflowService.createWorkflow()    â”‚
   â”‚                                     â”‚
   â”‚ Input:                              â”‚
   â”‚  - conversationId                   â”‚
   â”‚  - agentId                          â”‚
   â”‚  - originalMessage                  â”‚
   â”‚  - escalationReason                 â”‚
   â”‚  - templateId (optional)            â”‚
   â”‚                                     â”‚
   â”‚ Process:                            â”‚
   â”‚  1. Load template or use default    â”‚
   â”‚  2. Clone steps from template       â”‚
   â”‚  3. Set deadline                    â”‚
   â”‚  4. Create initial state snapshot   â”‚
   â”‚  5. Save to database                â”‚
   â”‚  6. Emit 'workflow:created' event   â”‚
   â”‚                                     â”‚
   â”‚ Output:                             â”‚
   â”‚  - Workflow object with ID          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼

3. NOTIFICATION
   Event emitted â†’ SSE â†’ User notified
        â”‚
        â–¼

4. APPROVAL ACTION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Approver receives notification      â”‚
   â”‚  (via Slack/Email/UI)               â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Approver submits decision           â”‚
   â”‚                                     â”‚
   â”‚ Via Webhook:                        â”‚
   â”‚  POST /api/webhook/slack            â”‚
   â”‚  {                                  â”‚
   â”‚    action: "approve",               â”‚
   â”‚    workflowId: "wf_123",            â”‚
   â”‚    approver: "user@co.com",         â”‚
   â”‚    formResponse: {...}              â”‚
   â”‚  }                                  â”‚
   â”‚                                     â”‚
   â”‚ Via UI:                             â”‚
   â”‚  POST /api/approvals/workflows/     â”‚
   â”‚       wf_123/approve                â”‚
   â”‚  {                                  â”‚
   â”‚    approver: "user@co.com",         â”‚
   â”‚    formResponse: {...}              â”‚
   â”‚  }                                  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼

5. STATE TRANSITION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ WorkflowService.approveStep()       â”‚
   â”‚                                     â”‚
   â”‚ Process:                            â”‚
   â”‚  1. Load workflow from DB           â”‚
   â”‚  2. Validate current state          â”‚
   â”‚  3. Create state snapshot           â”‚
   â”‚  4. Update current step status      â”‚
   â”‚  5. Save form response              â”‚
   â”‚  6. Check if last step              â”‚
   â”‚     - Yes: Mark APPROVED            â”‚
   â”‚     - No: Advance to next step      â”‚
   â”‚  7. Save to database                â”‚
   â”‚  8. Emit event                      â”‚
   â”‚                                     â”‚
   â”‚ Events emitted:                     â”‚
   â”‚  - workflow:step_advanced (if next) â”‚
   â”‚  - workflow:approved (if complete)  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼

6. NOTIFICATION & UPDATE
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Event listeners react               â”‚
   â”‚                                     â”‚
   â”‚ - SSE sends update to user          â”‚
   â”‚ - Next approver notified (if any)   â”‚
   â”‚ - Dashboard refreshes               â”‚
   â”‚ - Logs updated                      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      WORKFLOWS COLLECTION                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

{
  _id: ObjectId,
  workflowId: "wf_1729012345_abc123",          // Unique identifier
  conversationId: "conv_456",                   // Link to conversation
  agentId: "agent_123",                         // Owner agent
  status: "in_progress",                        // Workflow status
  templateId: "agent_123_multi_step_approval",  // Template used
  currentStep: 1,                               // Current step index
  
  steps: [                                      // Approval steps
    {
      stepNumber: 1,
      stepName: "Manager Review",
      approverRole: "manager",
      approverEmail: "manager@company.com",
      status: "approved",
      approvedBy: "manager@company.com",
      approvedAt: ISODate("2025-10-15T10:30:00Z"),
      response: "Approved - budget available",
      formFields: [...],                        // Field definitions
      formResponse: {                           // User's responses
        "budget_approved": true,
        "manager_comments": "Looks good"
      }
    },
    {
      stepNumber: 2,
      stepName: "Director Review",
      approverRole: "director",
      approverEmail: "director@company.com",
      status: "pending",
      formFields: [...]
    }
  ],
  
  originalMessage: "Purchase request for $5000",
  escalationReason: "Amount exceeds approval limit",
  
  metadata: {                                   // Custom data
    hasEmail: true,
    userEmail: "customer@example.com"
  },
  
  stateHistory: [                               // For rollback
    {
      timestamp: ISODate("2025-10-15T10:00:00Z"),
      status: "pending",
      currentStep: 0,
      data: {...},
      triggeredBy: "system",
      action: "workflow_created"
    },
    {
      timestamp: ISODate("2025-10-15T10:30:00Z"),
      status: "in_progress",
      currentStep: 1,
      data: {...},
      triggeredBy: "manager@company.com",
      action: "step_approved"
    }
  ],
  
  deadline: ISODate("2025-10-18T10:00:00Z"),
  createdAt: ISODate("2025-10-15T10:00:00Z"),
  updatedAt: ISODate("2025-10-15T10:30:00Z")
}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  APPROVAL_TEMPLATES COLLECTION                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

{
  _id: ObjectId,
  templateId: "agent_123_multi_step_approval",
  templateName: "Multi-Step Approval",
  description: "Three-tier approval chain",
  agentId: "agent_123",
  
  steps: [
    {
      stepNumber: 1,
      stepName: "Manager Review",
      approverRole: "manager",
      formFields: [
        {
          id: "budget_approved",
          type: "checkbox",
          label: "Budget Approved",
          required: true
        },
        {
          id: "manager_comments",
          type: "textarea",
          label: "Manager Comments",
          required: false
        }
      ]
    },
    {
      stepNumber: 2,
      stepName: "Director Review",
      approverRole: "director",
      formFields: [...]
    },
    {
      stepNumber: 3,
      stepName: "CFO Final Approval",
      approverRole: "cfo",
      formFields: [...]
    }
  ],
  
  globalDeadlineHours: 72,
  allowDelegation: true,
  allowSkip: false,
  notifyOnEachStep: true,
  isActive: true,
  
  createdAt: ISODate("2025-10-15T09:00:00Z"),
  updatedAt: ISODate("2025-10-15T09:00:00Z")
}
```

---

## ğŸ¯ Component Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COMPONENT INTERACTIONS                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AgentService
    â”‚
    â”œâ”€â–º WorkflowService.createWorkflow()
    â”‚       â”‚
    â”‚       â”œâ”€â–º ApprovalTemplate.findOne()
    â”‚       â”œâ”€â–º Workflow.create()
    â”‚       â””â”€â–º workflowEvents.emit('workflow:created')
    â”‚
    â””â”€â–º MemoryService.addMessage()

WebhookRoutes
    â”‚
    â”œâ”€â–º WorkflowService.approveStep()
    â”‚       â”‚
    â”‚       â”œâ”€â–º Workflow.findOne()
    â”‚       â”œâ”€â–º workflow.addStateSnapshot()
    â”‚       â”œâ”€â–º Workflow.save()
    â”‚       â””â”€â–º workflowEvents.emit('workflow:approved')
    â”‚
    â””â”€â–º WorkflowService.rejectStep()
            â”‚
            â”œâ”€â–º Workflow.findOne()
            â”œâ”€â–º workflow.addStateSnapshot()
            â”œâ”€â–º Workflow.save()
            â””â”€â–º workflowEvents.emit('workflow:rejected')

ApprovalRoutes
    â”‚
    â”œâ”€â–º WorkflowService.getWorkflow()
    â”œâ”€â–º WorkflowService.getPendingWorkflowsForApprover()
    â”œâ”€â–º WorkflowService.delegateApproval()
    â”œâ”€â–º WorkflowService.rollbackWorkflow()
    â””â”€â–º ApprovalTemplate.find()

ChatRoutes (SSE)
    â”‚
    â””â”€â–º workflowEvents.on('workflow:*')
            â”‚
            â””â”€â–º sendToUser() via SSE

ApprovalDashboard (UI)
    â”‚
    â”œâ”€â–º GET /api/approvals/pending/:email
    â””â”€â–º Displays workflows

DynamicApprovalForm (UI)
    â”‚
    â”œâ”€â–º POST /api/approvals/workflows/:id/approve
    â””â”€â–º POST /api/approvals/workflows/:id/reject
```

---

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      SECURITY LAYERS                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. AUTHENTICATION LAYER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ JWT Token Verification              â”‚
   â”‚  - authMiddleware()                 â”‚
   â”‚  - Cookie-based auth                â”‚
   â”‚  - Token expiration check           â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2. AUTHORIZATION LAYER
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Role-Based Access Control           â”‚
   â”‚  - Approver verification            â”‚
   â”‚  - Agent ownership check            â”‚
   â”‚  - Workflow access validation       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

3. WEBHOOK SECURITY
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Channel-Specific Verification       â”‚
   â”‚  - Slack: Signature verification    â”‚
   â”‚  - Email: Token validation          â”‚
   â”‚  - External: API key check          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

4. INPUT VALIDATION
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Data Sanitization                   â”‚
   â”‚  - Form field validation            â”‚
   â”‚  - Type checking                    â”‚
   â”‚  - Pattern matching                 â”‚
   â”‚  - Required field enforcement       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. AUDIT TRAIL
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Complete Action Logging             â”‚
   â”‚  - State snapshots                  â”‚
   â”‚  - Approver tracking                â”‚
   â”‚  - Timestamp logging                â”‚
   â”‚  - Action history                   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

*System Architecture Documentation*  
*Last Updated: October 15, 2025*  
*Version: 1.0 - Production Ready*
